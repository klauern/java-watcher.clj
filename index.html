<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Java 7 WatchService for Clojure by klauern</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Java 7 WatchService for Clojure</h1>
        <p class="header">Thin wrapper around Java 7's WatchService for Clojure</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/klauern/java-watcher.clj/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/klauern/java-watcher.clj/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/klauern/java-watcher.clj">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/klauern">klauern</a></p>


      </header>
      <section>
        <h1>java-watcher.clj</h1>

<p><a href="http://travis-ci.org/klauern/java-watcher.clj"><img src="https://secure.travis-ci.org/klauern/java7-watcher.clj.png" alt="Build Status"></a></p>

<p>Stupidly simple java7 file watch service.  This is largely a Clojure-ified wrapper around <a href="http://docs.oracle.com/javase/tutorial/essential/io/notification.html">Java 7's WatchService</a>, which works natively on Windows and Linux, but not entirely on OSX.  Don't use this if you run a Mac since OS X <a href="http://stackoverflow.com/a/11182515/7008">has no native file watching service</a>, but rather uses a poll-based approach.  Or rather, if you don't care that it uses a polling-based event tracker, go ahead and use this, but it won't be as performant as other options.</p>

<p>Maybe I will create or modify this to use something like <a href="http://jnotify.sourceforge.net/">JNotify</a>, which has cross-platform binaries for native file changes, and it works without Java 7.</p>

<h2>Creating Watches</h2>

<p>Include this in your <code>project.clj</code>:</p>

<div class="highlight"><pre><span class="p">[</span><span class="nv">com.klauer/java-watcher</span> <span class="s">"0.1.0-SNAPSHOT"</span><span class="p">]</span>
</pre></div>

<p>There are two ways to go about creating a watch:</p>

<h3>Syntax-sugary way</h3>

<div class="highlight"><pre><span class="p">(</span><span class="nf">register-watch</span> <span class="s">"/some/path/directory/here"</span> <span class="p">[</span><span class="ss">:modify</span><span class="p">]</span> <span class="o">#</span><span class="p">(</span><span class="nb">println </span><span class="s">"hello event "</span> <span class="nv">%</span><span class="p">))</span>
</pre></div>

<p>The arguments are "path", [:modify :create :delete], function.  The vector can be one of :</p>

<pre><code>* :create (creation events)
* :modify (create and change events)
* :delete (file/directory deletion)
</code></pre>

<p>Where these <code>kinds</code> mirror Java's <code>StandardWatchEventKinds/ENTRY_CREATE</code>, <code>ENTRY_DELETE</code>, and/or <code>ENTRY_MODIFY</code>.</p>

<p>When something changes in that directory:</p>

<pre><code>$ cd /some/path/directory/here
$ touch make a couple files
</code></pre>

<p>You'll be greeted by your oh-so-fancy function you passed in for each of the events created (in the above example, 4 files were created):</p>

<pre><code>hello event  {:kind #&lt;StdWatchEventKind ENTRY_MODIFY&gt;, :path /some/path/directory/here/a}
hello event  {:kind #&lt;StdWatchEventKind ENTRY_MODIFY&gt;, :path /some/path/directory/here/couple}
hello event  {:kind #&lt;StdWatchEventKind ENTRY_MODIFY&gt;, :path /some/path/directory/here/files}
hello event  {:kind #&lt;StdWatchEventKind ENTRY_MODIFY&gt;, :path /some/path/directory/here/make}
</code></pre>

<p>So define a method to call which will take in the event map of <code>:kind</code> and <code>:path</code>, so you know what file changed and how.</p>

<h3>More manual-control, choose-your-own-adventure way</h3>

<p>The above is just sugar around these calls:</p>

<ol>
<li>
<p>Create a directory to watch for file changes:</p>

<div class="highlight"><pre><span class="p">(</span><span class="k">def </span><span class="nv">example-directory</span> <span class="p">(</span><span class="nf">make-path</span> <span class="s">"/Users/klauer/dev/clojure/java7-watcher.clj/watchabledir"</span><span class="p">))</span>
</pre></div>
</li>
<li>
<p>Register the service so it tracks whatever <code>kinds</code> of changes to whichever directory/ies you want: <code>:create</code>, <code>:modify</code>, or <code>:delete</code>.</p>

<div class="highlight"><pre><span class="c1">;; can use any combination of elements in `kinds`, even `(vals kinds)` itself</span>
<span class="c1">;; `@watch-service` is an atom for the FileSystem watch service.</span>
<span class="p">(</span><span class="nf">register-with</span> <span class="nv">example-directory</span> <span class="err">@</span><span class="nv">watch-service</span> <span class="p">[(</span><span class="ss">:create</span> <span class="nv">kinds</span><span class="p">)</span> <span class="p">(</span><span class="ss">:delete</span> <span class="nv">kinds</span><span class="p">)])</span>
</pre></div>
</li>
<li>
<p>call <code>pipeline-events-with</code> and pass in a function to call when something changes:</p>

<div class="highlight"><pre><span class="p">(</span><span class="nf">pipeline-events-with</span> <span class="err">@</span><span class="nv">watch-service</span> <span class="o">#</span><span class="p">(</span><span class="nb">println </span><span class="s">"Oh Happy Day"</span><span class="p">)</span> <span class="nv">extra</span> <span class="nv">args</span> <span class="nv">here</span><span class="p">)</span>
<span class="c1">;; This is asynchronous through the use of the ever-nifty Lamina project (https://github.com/ztellman/lamina).</span>
</pre></div>
</li>
<li>
<p>All registered watches are stored in the <code>*registered-watches*</code> atom, and can be removed by calling <code>unregister-watch</code>:</p>

<div class="highlight"><pre><span class="p">(</span><span class="nf">unregister-watch</span> <span class="p">(</span><span class="nb">first </span><span class="err">@</span><span class="nv">*registered-watches*</span><span class="p">))</span>
<span class="c1">;; this not only removes it from the atom, but unregisters your passed-in function and any</span>
<span class="c1">;; handling of future file-system events it was registered for.</span>
</pre></div>
</li>
</ol><h2>Things Missing</h2>

<p>There's actually a bit more I haven't gotten to:</p>

<ol>
<li>tests</li>
<li>more fine-grained control of these watches:

<ul>
<li>start</li>
<li>stop</li>
<li>pause</li>
<li>etc.</li>
</ul>
</li>
<li>defining multiple functions to be called with the same watch</li>
<li>redefining a watch and it's function to be called</li>
<li>better granularity on functions and directory events:

<ul>
<li>be able to call a function for one directory event (:delete) and another for a different
event (:create) in the same directory</li>
</ul>
</li>
</ol><h2>Reference</h2>

<p>See these docs around the Java API.  There's not much in the way of wrapping these Java types, so your best bet is just to adhere to whatever the JDK defined:</p>

<ul>
<li><a href="http://docs.oracle.com/javase/7/docs/api/index.html?java/nio/file/WatchService.html">WatchService</a></li>
<li>
<a href="http://docs.oracle.com/javase/tutorial/essential/io/notification.html">Java tutorial on using it</a> (in Java, of course)</li>
<li>
<a href="http://jnotify.sourceforge.net/">JNotify</a>  (in case you would like something that works on Java 6 or natively on the Mac)</li>
<li>
<a href="http://jpathwatch.wordpress.com/">JPathWatch</a> is similar to JNotify, but wraps the Java 7 API, so you could drop this in your project and not have to change the API much.</li>
</ul><h2>Compatibility</h2>

<p>As this uses a Java 7 API, it is assumed you'll be running on Java 7+.</p>

<p>Mac OS X compatibility with this is lacking.  It works, but it's poll-based only, which at this time means you can't really track alot of changes at once (renaming the same file twice might only trigger one event).  See <a href="https://wikis.oracle.com/display/OpenJDK/Mac+OS+X+Port+Project+Status">this link</a> for more information on OS X compatibility with JDK7 features.  It's coming along, but not there yet.</p>

<h2>License</h2>

<p>Copyright Â© 2012 Nick Klauer (klauer @ gmail)</p>

<p>Distributed under the Eclipse Public License, the same as Clojure.</p>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		          <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-35380114-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>